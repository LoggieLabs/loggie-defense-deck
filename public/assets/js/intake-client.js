import{a as C,c as A,d as q,e as Q}from"./chunks/chunk-6657MIAK.js";import"./chunks/chunk-IEMWPDDY.js";import{c as G}from"./chunks/chunk-SU2Z73VX.js";var E=G(Q(),1),u=null;async function h(t=!1){if(u&&!t)return u;let e=typeof globalThis.crypto?.getRandomValues=="function";return u={available:e,webCrypto:e,kyber:!1,error:e?void 0:"Missing: WebCrypto"},u}function Z(t){u&&(u={...u,kyber:t})}function v(){u=null}var ee=new TextEncoder;function H(t){return typeof t=="string"?ee.encode(t):t}function k(t){let e="";for(let r=0;r<t.length;r++)e+=String.fromCharCode(t[r]);return btoa(e)}function te(t){return Array.from(t).map(e=>e.toString(16).padStart(2,"0")).join("")}function re(t){let e=t.startsWith("0x")?t.slice(2):t,r=e.length%2?"0"+e:e,n=new Uint8Array(r.length/2);for(let o=0;o<n.length;o++)n[o]=parseInt(r.slice(o*2,o*2+2),16);return n}function ne(){return globalThis.crypto.getRandomValues(new Uint8Array(32))}function F(){return globalThis.crypto.getRandomValues(new Uint8Array(24))}function oe(t){return q(t)}function ae(t,e){let r=e?.salt??new Uint8Array(32),n=e?.info??new Uint8Array(0),o=e?.length,a=A(C,r,t),i=new Uint8Array(0),p=[];for(let c=1;c<=Math.ceil(o/32);c++){let y=new Uint8Array(i.length+n.length+1);y.set(i,0),y.set(n,i.length),y[y.length-1]=c,i=new Uint8Array(A(C,a,y)),p.push(i)}let d=new Uint8Array(o),s=0;for(let c of p)if(d.set(c.subarray(0,o-s),s),s+=c.length,s>=o)break;return d}function W(t,e,r){return E.default.secretbox(e,r,t)}var ie="omnituum.hybrid.v1",se="xsalsa20poly1305";function V(t){return Array.from(t).map(e=>e.toString(16).padStart(2,"0")).join("")}function x(t){let e=JSON.stringify(t),r=new TextEncoder,n=oe(r.encode(e));return V(n)}var ce=60*1e3,le=2,b=[];function ue(t,e){if(t===!1||e)return!0;let r=t?.windowMs??ce,n=t?.max??le,o=Date.now();for(;b.length>0&&b[0]<o-r;)b.shift();return b.length<n}function ye(){b.push(Date.now())}var S=null;async function pe(){if(S)return S;try{return S=await import("./chunks/dist-PFEIJC3R.js"),S}catch{return null}}async function de(t,e){let r=await pe();if(!r)throw new Error("Hybrid encryption unavailable: pqc-shared module failed to load (WASM blocked by CSP?)");return r.hybridEncrypt(t,e)}var _="loggie.intake.pending",me=300*1e3;function fe(t=_,e=me){try{let r=sessionStorage.getItem(t);if(!r)return null;let n=JSON.parse(r);return Date.now()-n.ts>e?(P(t),null):n.id}catch{return null}}function be(t,e=_){try{let r={id:t,ts:Date.now()};sessionStorage.setItem(e,JSON.stringify(r))}catch{}}function P(t=_){try{sessionStorage.removeItem(t)}catch{}}var he="loggie.intake.v1",ge=32*1024,we=56*1024;async function I(t,e,r={}){try{if(r.honeypot)return{ok:!0,id:"",status:"created"};let n=e.canonicalize(t),o=x(n),a=e.storageKey??"loggie.intake.pending",i=e.pendingTtlMs??300*1e3,p=e.maxPlaintextBytes??ge,d=e.maxEnvelopeBytes??we,s=e.version??he,y=fe(a,i)===o;if(!ue(e.rateLimit,y))return{ok:!1,error:"Too many submissions. Please wait a moment before trying again."};let U=await h();if(!U.available)return{ok:!1,error:`Your browser cannot securely submit this form. ${U.error}. Please use a modern browser (Chrome, Firefox, Safari, Edge).`};let X=e.requireKyber===!0,B=e.attemptHybrid!==!1,$=JSON.stringify(n),f=new TextEncoder().encode($);if(f.length>p)return{ok:!1,error:`Submission too large (${Math.round(f.length/1024)}KB). Please shorten your responses.`};let g,O=!1;if(!B)g=await T(f,e.publicKeys.x25519PubHex);else try{g=await de(f,{x25519PubHex:e.publicKeys.x25519PubHex,kyberPubB64:e.publicKeys.kyberPubB64}),O=!0,Z(!0)}catch(l){if(X)return{ok:!1,error:"Post-quantum encryption unavailable in this environment (WASM blocked by CSP or unsupported browser). Cannot submit in strict hybrid mode."};let K=l instanceof Error?l.message:String(l),R=ke(K),z={event:"omnituum.crypto.downgrade",reason:R,suite:j,pqcUsed:!1,requireKyber:!1,userAgent:typeof navigator<"u"?navigator.userAgent:void 0,cspHint:R==="wasm_blocked"?"WASM compilation likely blocked by Content-Security-Policy":void 0,...e.debugDowngrade?{rawError:K}:{}};console.warn("[Intake] Crypto downgrade:",z),e.onDowngrade?.(z),g=await T(f,e.publicKeys.x25519PubHex)}let Y={v:s,id:o,pqcUsed:O,encrypted:JSON.stringify(g)},N=JSON.stringify(Y);if(N.length>d)return{ok:!1,error:"Encrypted submission too large. Please shorten your responses."};be(o,a);let w=await fetch(e.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:N}),m=w.status;if(m===201||m===200){let l=await w.json();return P(a),l.ok?(ye(),{ok:!0,id:l.id,status:l.status}):{ok:!1,error:l.error||"Unknown error"}}return m>=400&&m<500?(P(a),{ok:!1,error:(await w.json().catch(()=>({}))).error||`Request error: ${m}`}):{ok:!1,error:(await w.json().catch(()=>({}))).error||`Server error: ${m}. Please try again.`}}catch(n){return console.error("Intake submission error:",n),{ok:!1,error:n instanceof Error?n.message:"Submission failed. Please try again."}}}function ke(t){let e=t.toLowerCase();return e.includes("csp")||e.includes("wasm")||e.includes("webassembly")?"wasm_blocked":e.includes("failed to load")||e.includes("module")||e.includes("import")?"module_load_failed":e.includes("unavailable")||e.includes("not available")?"kyber_unavailable":e.includes("encrypt")?"encrypt_failed":"unknown"}var j="x25519";function Se(t,e,r){return ae(t,{salt:H(e),info:H(r),length:32})}async function T(t,e){let r=ne(),n=F(),o=W(r,t,n),a=E.default.box.keyPair(),i=re(e),p=E.default.scalarMult(a.secretKey,i),d=Se(p,"omnituum/x25519","wrap-ck"),s=F(),c=W(d,r,s);return{v:ie,suite:j,aead:se,x25519Epk:te(a.publicKey),x25519Wrap:{nonce:k(s),wrapped:k(c)},kyberKemCt:"",kyberWrap:{nonce:"",wrapped:""},contentNonce:k(n),ciphertext:k(o),meta:{createdAt:new Date().toISOString()}}}function L(t){return t.trim().replace(/\r\n?/g,`
`)}function D(t){return t.trim().toLowerCase()}function M(t){return[...t].sort()}function J(t,e){return{kind:e,email:D(t.email),company:t.company.trim(),system:L(t.system),useCase:t.useCase,timeline:t.timeline,compliance:M(t.compliance)}}function Ee(t){return{submit(e,r="request_pilot_access",n){return I(e,{...t,canonicalize:o=>J(o,r)},{honeypot:n})},checkCryptoCapability:h,resetCryptoCapabilityCache:v,generateId(e,r="request_pilot_access"){return x(J(e,r))}}}export{h as checkCryptoCapability,Ee as createPilotAccessClient,v as resetCryptoCapabilityCache};
