import{a as A,c as P,d as K,e as Y}from"./chunks/chunk-VC43Z2T2.js";import"./chunks/chunk-75GD3YN4.js";import{c as $}from"./chunks/chunk-SU2Z73VX.js";var E=$(Y(),1),u=null;async function b(e=!1){if(u&&!e)return u;let t=typeof globalThis.crypto?.getRandomValues=="function";return u={available:t,webCrypto:t,kyber:!1,error:t?void 0:"Missing: WebCrypto"},u}function G(e){u&&(u={...u,kyber:e})}function C(){u=null}var Q=new TextEncoder;function R(e){return typeof e=="string"?Q.encode(e):e}function k(e){let t="";for(let r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return btoa(t)}function Z(e){return Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("")}function ee(e){let t=e.startsWith("0x")?e.slice(2):e,r=t.length%2?"0"+t:t,n=new Uint8Array(r.length/2);for(let o=0;o<n.length;o++)n[o]=parseInt(r.slice(o*2,o*2+2),16);return n}function te(){return globalThis.crypto.getRandomValues(new Uint8Array(32))}function q(){return globalThis.crypto.getRandomValues(new Uint8Array(24))}function re(e){return K(e)}function ne(e,t){let r=t?.salt??new Uint8Array(32),n=t?.info??new Uint8Array(0),o=t?.length,a=P(A,r,e),i=new Uint8Array(0),p=[];for(let c=1;c<=Math.ceil(o/32);c++){let y=new Uint8Array(i.length+n.length+1);y.set(i,0),y.set(n,i.length),y[y.length-1]=c,i=new Uint8Array(P(A,a,y)),p.push(i)}let m=new Uint8Array(o),s=0;for(let c of p)if(m.set(c.subarray(0,o-s),s),s+=c.length,s>=o)break;return m}function H(e,t,r){return E.default.secretbox(t,r,e)}var oe="omnituum.hybrid.v1",ae="xsalsa20poly1305";function W(e){return Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("")}function x(e){let t=JSON.stringify(e),r=new TextEncoder,n=re(r.encode(t));return W(n)}var ie=60*1e3,se=2,f=[];function ce(e,t){if(e===!1||t)return!0;let r=e?.windowMs??ie,n=e?.max??se,o=Date.now();for(;f.length>0&&f[0]<o-r;)f.shift();return f.length<n}function le(){f.push(Date.now())}var S=null;async function ue(){if(S)return S;try{return S=await import("./chunks/dist-EO654JVP.js"),S}catch{return null}}async function ye(e,t){let r=await ue();if(!r)throw new Error("Hybrid encryption unavailable: pqc-shared module failed to load (WASM blocked by CSP?)");return r.hybridEncrypt(e,t)}var I="loggie.intake.pending",pe=300*1e3;function me(e=I,t=pe){try{let r=sessionStorage.getItem(e);if(!r)return null;let n=JSON.parse(r);return Date.now()-n.ts>t?(T(e),null):n.id}catch{return null}}function de(e,t=I){try{let r={id:e,ts:Date.now()};sessionStorage.setItem(t,JSON.stringify(r))}catch{}}function T(e=I){try{sessionStorage.removeItem(e)}catch{}}var fe="loggie.intake.v1",be=32*1024,he=56*1024;async function L(e,t,r={}){try{if(r.honeypot)return{ok:!0,id:"",status:"created"};let n=t.canonicalize(e),o=x(n),a=t.storageKey??"loggie.intake.pending",i=t.pendingTtlMs??300*1e3,p=t.maxPlaintextBytes??be,m=t.maxEnvelopeBytes??he,s=t.version??fe,y=me(a,i)===o;if(!ce(t.rateLimit,y))return{ok:!1,error:"Too many submissions. Please wait a moment before trying again."};let D=await b();if(!D.available)return{ok:!1,error:`Your browser cannot securely submit this form. ${D.error}. Please use a modern browser (Chrome, Firefox, Safari, Edge).`};let J=t.requireKyber===!0,X=JSON.stringify(n),h=new TextEncoder().encode(X);if(h.length>p)return{ok:!1,error:`Submission too large (${Math.round(h.length/1024)}KB). Please shorten your responses.`};let v,O=!1;try{v=await ye(h,{x25519PubHex:t.publicKeys.x25519PubHex,kyberPubB64:t.publicKeys.kyberPubB64}),O=!0,G(!0)}catch(l){if(J)return{ok:!1,error:"Post-quantum encryption unavailable in this environment (WASM blocked by CSP or unsupported browser). Cannot submit in strict hybrid mode."};let w=l instanceof Error?l.message:String(l),z={event:"omnituum.crypto.downgrade",reason:w,suite:F,pqcUsed:!1,requireKyber:!1,userAgent:typeof navigator<"u"?navigator.userAgent:void 0,cspHint:w.includes("CSP")||w.includes("wasm")||w.includes("WASM")?"WASM compilation likely blocked by Content-Security-Policy":void 0};console.warn("[Intake] Crypto downgrade:",z),t.onDowngrade?.(z),v=await V(h,t.publicKeys.x25519PubHex)}let B={v:s,id:o,pqcUsed:O,encrypted:JSON.stringify(v)},N=JSON.stringify(B);if(N.length>m)return{ok:!1,error:"Encrypted submission too large. Please shorten your responses."};de(o,a);let g=await fetch(t.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:N}),d=g.status;if(d===201||d===200){let l=await g.json();return T(a),l.ok?(le(),{ok:!0,id:l.id,status:l.status}):{ok:!1,error:l.error||"Unknown error"}}return d>=400&&d<500?(T(a),{ok:!1,error:(await g.json().catch(()=>({}))).error||`Request error: ${d}`}):{ok:!1,error:(await g.json().catch(()=>({}))).error||`Server error: ${d}. Please try again.`}}catch(n){return console.error("Intake submission error:",n),{ok:!1,error:n instanceof Error?n.message:"Submission failed. Please try again."}}}var F="x25519";function ge(e,t,r){return ne(e,{salt:R(t),info:R(r),length:32})}async function V(e,t){let r=te(),n=q(),o=H(r,e,n),a=E.default.box.keyPair(),i=ee(t),p=E.default.scalarMult(a.secretKey,i),m=ge(p,"omnituum/x25519","wrap-ck"),s=q(),c=H(m,r,s);return{v:oe,suite:F,aead:ae,x25519Epk:Z(a.publicKey),x25519Wrap:{nonce:k(s),wrapped:k(c)},kyberKemCt:"",kyberWrap:{nonce:"",wrapped:""},contentNonce:k(n),ciphertext:k(o),meta:{createdAt:new Date().toISOString()}}}function M(e){return e.trim().replace(/\r\n?/g,`
`)}function U(e){return e.trim().toLowerCase()}function _(e){return[...e].sort()}function j(e,t){return{kind:t,email:U(e.email),company:e.company.trim(),system:M(e.system),useCase:e.useCase,timeline:e.timeline,compliance:_(e.compliance)}}function we(e){return{submit(t,r="request_pilot_access",n){return L(t,{...e,canonicalize:o=>j(o,r)},{honeypot:n})},checkCryptoCapability:b,resetCryptoCapabilityCache:C,generateId(t,r="request_pilot_access"){return x(j(t,r))}}}export{b as checkCryptoCapability,we as createPilotAccessClient,C as resetCryptoCapabilityCache};
