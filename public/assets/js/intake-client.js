import{a as x,c as A,d as K,e as G}from"./chunks/chunk-6657MIAK.js";import"./chunks/chunk-IEMWPDDY.js";import{c as Y}from"./chunks/chunk-SU2Z73VX.js";var S=Y(G(),1),u=null;async function b(t=!1){if(u&&!t)return u;let e=typeof globalThis.crypto?.getRandomValues=="function";return u={available:e,webCrypto:e,kyber:!1,error:e?void 0:"Missing: WebCrypto"},u}function Q(t){u&&(u={...u,kyber:t})}function E(){u=null}var Z=new TextEncoder;function q(t){return typeof t=="string"?Z.encode(t):t}function w(t){let e="";for(let r=0;r<t.length;r++)e+=String.fromCharCode(t[r]);return btoa(e)}function ee(t){return Array.from(t).map(e=>e.toString(16).padStart(2,"0")).join("")}function te(t){let e=t.startsWith("0x")?t.slice(2):t,r=e.length%2?"0"+e:e,n=new Uint8Array(r.length/2);for(let o=0;o<n.length;o++)n[o]=parseInt(r.slice(o*2,o*2+2),16);return n}function re(){return globalThis.crypto.getRandomValues(new Uint8Array(32))}function H(){return globalThis.crypto.getRandomValues(new Uint8Array(24))}function ne(t){return K(t)}function oe(t,e){let r=e?.salt??new Uint8Array(32),n=e?.info??new Uint8Array(0),o=e?.length,a=A(x,r,t),i=new Uint8Array(0),d=[];for(let c=1;c<=Math.ceil(o/32);c++){let y=new Uint8Array(i.length+n.length+1);y.set(i,0),y.set(n,i.length),y[y.length-1]=c,i=new Uint8Array(A(x,a,y)),d.push(i)}let p=new Uint8Array(o),s=0;for(let c of d)if(p.set(c.subarray(0,o-s),s),s+=c.length,s>=o)break;return p}function F(t,e,r){return S.default.secretbox(e,r,t)}var ae="omnituum.hybrid.v1",ie="xsalsa20poly1305";function W(t){return Array.from(t).map(e=>e.toString(16).padStart(2,"0")).join("")}function v(t){let e=JSON.stringify(t),r=new TextEncoder,n=ne(r.encode(e));return W(n)}var se=60*1e3,ce=2,f=[];function le(t,e){if(t===!1||e)return!0;let r=t?.windowMs??se,n=t?.max??ce,o=Date.now();for(;f.length>0&&f[0]<o-r;)f.shift();return f.length<n}function ue(){f.push(Date.now())}var k=null;async function ye(){if(k)return k;try{return k=await import("./chunks/dist-PFEIJC3R.js"),k}catch{return null}}async function de(t,e){let r=await ye();if(!r)throw new Error("Hybrid encryption unavailable: pqc-shared module failed to load (WASM blocked by CSP?)");return r.hybridEncrypt(t,e)}var T="loggie.intake.pending",pe=300*1e3;function me(t=T,e=pe){try{let r=sessionStorage.getItem(t);if(!r)return null;let n=JSON.parse(r);return Date.now()-n.ts>e?(P(t),null):n.id}catch{return null}}function fe(t,e=T){try{let r={id:t,ts:Date.now()};sessionStorage.setItem(e,JSON.stringify(r))}catch{}}function P(t=T){try{sessionStorage.removeItem(t)}catch{}}var be="loggie.intake.v1",ge=32*1024,he=56*1024;async function _(t,e,r={}){try{if(r.honeypot)return{ok:!0,id:"",status:"created"};let n=e.canonicalize(t),o=v(n),a=e.storageKey??"loggie.intake.pending",i=e.pendingTtlMs??300*1e3,d=e.maxPlaintextBytes??ge,p=e.maxEnvelopeBytes??he,s=e.version??be,y=me(a,i)===o;if(!le(e.rateLimit,y))return{ok:!1,error:"Too many submissions. Please wait a moment before trying again."};let M=await b();if(!M.available)return{ok:!1,error:`Your browser cannot securely submit this form. ${M.error}. Please use a modern browser (Chrome, Firefox, Safari, Edge).`};let X=e.requireKyber===!0,B=JSON.stringify(n),g=new TextEncoder().encode(B);if(g.length>d)return{ok:!1,error:`Submission too large (${Math.round(g.length/1024)}KB). Please shorten your responses.`};let C,U=!1;try{C=await de(g,{x25519PubHex:e.publicKeys.x25519PubHex,kyberPubB64:e.publicKeys.kyberPubB64}),U=!0,Q(!0)}catch(l){if(X)return{ok:!1,error:"Post-quantum encryption unavailable in this environment (WASM blocked by CSP or unsupported browser). Cannot submit in strict hybrid mode."};let N=l instanceof Error?l.message:String(l),R=we(N),z={event:"omnituum.crypto.downgrade",reason:R,suite:V,pqcUsed:!1,requireKyber:!1,userAgent:typeof navigator<"u"?navigator.userAgent:void 0,cspHint:R==="wasm_blocked"?"WASM compilation likely blocked by Content-Security-Policy":void 0,...e.debugDowngrade?{rawError:N}:{}};console.warn("[Intake] Crypto downgrade:",z),e.onDowngrade?.(z),C=await j(g,e.publicKeys.x25519PubHex)}let $={v:s,id:o,pqcUsed:U,encrypted:JSON.stringify(C)},O=JSON.stringify($);if(O.length>p)return{ok:!1,error:"Encrypted submission too large. Please shorten your responses."};fe(o,a);let h=await fetch(e.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:O}),m=h.status;if(m===201||m===200){let l=await h.json();return P(a),l.ok?(ue(),{ok:!0,id:l.id,status:l.status}):{ok:!1,error:l.error||"Unknown error"}}return m>=400&&m<500?(P(a),{ok:!1,error:(await h.json().catch(()=>({}))).error||`Request error: ${m}`}):{ok:!1,error:(await h.json().catch(()=>({}))).error||`Server error: ${m}. Please try again.`}}catch(n){return console.error("Intake submission error:",n),{ok:!1,error:n instanceof Error?n.message:"Submission failed. Please try again."}}}function we(t){let e=t.toLowerCase();return e.includes("csp")||e.includes("wasm")||e.includes("webassembly")?"wasm_blocked":e.includes("failed to load")||e.includes("module")||e.includes("import")?"module_load_failed":e.includes("unavailable")||e.includes("not available")?"kyber_unavailable":e.includes("encrypt")?"encrypt_failed":"unknown"}var V="x25519";function ke(t,e,r){return oe(t,{salt:q(e),info:q(r),length:32})}async function j(t,e){let r=re(),n=H(),o=F(r,t,n),a=S.default.box.keyPair(),i=te(e),d=S.default.scalarMult(a.secretKey,i),p=ke(d,"omnituum/x25519","wrap-ck"),s=H(),c=F(p,r,s);return{v:ae,suite:V,aead:ie,x25519Epk:ee(a.publicKey),x25519Wrap:{nonce:w(s),wrapped:w(c)},kyberKemCt:"",kyberWrap:{nonce:"",wrapped:""},contentNonce:w(n),ciphertext:w(o),meta:{createdAt:new Date().toISOString()}}}function I(t){return t.trim().replace(/\r\n?/g,`
`)}function L(t){return t.trim().toLowerCase()}function D(t){return[...t].sort()}function J(t,e){return{kind:e,email:L(t.email),company:t.company.trim(),system:I(t.system),useCase:t.useCase,timeline:t.timeline,compliance:D(t.compliance)}}function Se(t){return{submit(e,r="request_pilot_access",n){return _(e,{...t,canonicalize:o=>J(o,r)},{honeypot:n})},checkCryptoCapability:b,resetCryptoCapabilityCache:E,generateId(e,r="request_pilot_access"){return v(J(e,r))}}}export{b as checkCryptoCapability,Se as createPilotAccessClient,E as resetCryptoCapabilityCache};
